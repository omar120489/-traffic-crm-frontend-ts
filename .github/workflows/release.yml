name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable Corepack
        run: corepack enable

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Check if release notes exist
        id: check_notes
        run: |
          if [ -f "GITHUB_RELEASE_v${{ steps.version.outputs.version }}.md" ]; then
            echo "notes_exist=true" >> $GITHUB_OUTPUT
            echo "notes_file=GITHUB_RELEASE_v${{ steps.version.outputs.version }}.md" >> $GITHUB_OUTPUT
          else
            echo "notes_exist=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: generate_notes
        if: steps.check_notes.outputs.notes_exist == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.generateReleaseNotes({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: '${{ steps.version.outputs.tag }}'
            });
            return data.body;
          result-encoding: string

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: ${{ steps.check_notes.outputs.notes_exist == 'true' && steps.check_notes.outputs.notes_file || '' }}
          body: ${{ steps.check_notes.outputs.notes_exist == 'false' && steps.generate_notes.outputs.result || '' }}
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: create-release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: TypeScript check
        run: pnpm typecheck

      - name: Lint
        run: pnpm lint

      - name: Build frontend
        run: pnpm --filter ./apps/frontend run build

      - name: Build backend
        run: pnpm --filter ./apps/core-api run build

      - name: Run tests
        run: pnpm test

      - name: Upload frontend build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: apps/frontend/dist
          retention-days: 30

      - name: Upload backend build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: apps/core-api/dist
          retention-days: 30

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: apps/frontend/dist

      - name: Download backend artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: apps/core-api/dist

      - name: Deploy to staging
        run: |
          echo "ðŸš€ Deploying to staging..."
          # Add your deployment commands here
          # Examples:
          # - Vercel: vercel deploy --prod
          # - Netlify: netlify deploy --prod
          # - AWS: aws s3 sync ./dist s3://bucket-name
          # - Docker: docker build && docker push && kubectl apply
          echo "âœ… Deployment complete"

      - name: Wait for staging rollout
        run: sleep 15

      - name: Health check - staging
        env:
          STAGING_URL: ${{ vars.STAGING_PUBLIC_URL || 'https://staging.example.com' }}
        run: |
          echo "ðŸ” Checking staging health endpoint..."
          url="${STAGING_URL}/health"
          echo "Health URL: $url"
          
          for i in {1..10}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$url" || echo "000")
            echo "Attempt $i: $code"
            
            if [ "$code" -eq 200 ]; then
              echo "âœ… Staging health check passed"
              exit 0
            fi
            
            sleep 5
          done
          
          echo "âŒ Staging health check failed after 10 attempts"
          exit 1

      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running additional smoke tests on staging..."
          # Add additional smoke test commands here
          # curl -f https://staging.example.com/api/health || exit 1
          echo "âœ… Smoke tests passed"

  deploy-production:
    name: Deploy to Production
    needs: [create-release, build-and-test, deploy-staging]
    if: success()
    uses: ./.github/workflows/deploy-production.yml
    secrets:
      PROD_API_KEY: ${{ secrets.PROD_API_KEY }}
      PROD_DEPLOY_URL: ${{ secrets.PROD_DEPLOY_URL }}

  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [create-release, build-and-test, deploy-staging, deploy-production]
    if: always()

    steps:
      - name: Check job status
        id: check
        run: |
          if [ "${{ needs.create-release.result }}" == "success" ] && \
             [ "${{ needs.build-and-test.result }}" == "success" ] && \
             [ "${{ needs.deploy-staging.result }}" == "success" ] && \
             [ "${{ needs.deploy-production.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "message=Release deployed successfully to staging and production!" >> $GITHUB_OUTPUT
          elif [ "${{ needs.deploy-staging.result }}" == "success" ]; then
            echo "status=partial" >> $GITHUB_OUTPUT
            echo "emoji=âš ï¸" >> $GITHUB_OUTPUT
            echo "message=Release deployed to staging, but production deployment failed." >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "message=Release deployment failed. Check logs for details." >> $GITHUB_OUTPUT
          fi

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        if: always()
        uses: slackapi/slack-github-action@v1
        continue-on-error: true
        with:
          payload: |
            {
              "text": "${{ steps.check.outputs.emoji }} Release v${{ steps.version.outputs.version }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.check.outputs.emoji }} Release v${{ steps.version.outputs.version }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.check.outputs.message }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ steps.check.outputs.status }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nStaging + Production"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Release"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
