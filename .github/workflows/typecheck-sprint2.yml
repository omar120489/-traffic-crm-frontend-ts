name: sprint2-typecheck

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

# Auto-cancel stale runs on same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Lint documentation
        run: npx markdownlint-cli2 'docs/**/*.md' 'README.md' 'CONTRIBUTING.md'

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Configure pnpm store
        run: pnpm config set store-dir ~/.pnpm-store

      - name: Install dependencies
        run: pnpm -r install --frozen-lockfile

      - name: TypeCheck Sprint 2
        run: pnpm --filter ./apps/frontend run typecheck:sprint2

      - name: On failure, show changed TS files
        if: failure()
        run: |
          echo "### ❌ TypeCheck Failed - Changed Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          git fetch origin ${{ github.base_ref || 'main' }} --depth=1 || true
          git diff --name-only origin/${{ github.base_ref || 'main' }}... | grep -E '\.tsx?$' || echo "No TS files changed"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Track migration progress
        if: always()
        run: |
          SHIM_COUNT=$(grep -c "declare module" apps/frontend/src/legacy/ambient.d.ts || echo "0")
          echo "### 📊 Legacy Migration Progress" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Remaining shims:** \`$SHIM_COUNT\`" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** \`0\` (100% typed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$SHIM_COUNT" -eq 0 ]; then
            echo "🎉 **Migration complete!** All legacy code is now typed." >> $GITHUB_STEP_SUMMARY
          else
            PERCENT=$((100 - (SHIM_COUNT * 100 / 50)))  # Assuming ~50 initial shims
            echo "**Progress:** ~${PERCENT}% complete" >> $GITHUB_STEP_SUMMARY
          fi
