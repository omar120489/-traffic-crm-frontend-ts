import{importShared as x}from"./__federation_fn_import-CJIdJiQv.js";import{j as e}from"./useForkRef-BC7kqYKT.js";import{A as O}from"./AppPage-CfPA9hni.js";import{a as _}from"./index-DaH8T902.js";import{l as G}from"./index-BDGyx5_k.js";const T=_.create({baseURL:"/",withCredentials:!0});async function H(t){const{data:s}=await T.get("/chat/rooms",{params:t});return s}async function B(t,s={}){const{data:r}=await T.get(`/chat/rooms/${t}/messages`,{params:s});return r}async function V(t,s){const{data:r}=await T.post(`/chat/rooms/${t}/messages`,s);return r}const{useEffect:Y,useMemo:q,useRef:J}=await x("react");function N(t=!0){const s=localStorage.getItem("serviceToken")||sessionStorage.getItem("serviceToken"),r=J(null),i=q(()=>{if(!t)return null;const n=G("/",{path:"/socket.io",transports:["websocket"],auth:{token:s},reconnection:!0,reconnectionAttempts:1/0,reconnectionDelay:500,reconnectionDelayMax:5e3});return r.current=n,n},[t,s]);return Y(()=>()=>{r.current?.close(),r.current=null},[]),i}const{useEffect:D,useState:k}=await x("react"),{useSearchParams:Q}=await x("react-router-dom");function X(){const[t,s]=Q(),[r,i]=k(!1),[n,c]=k(null),[u,o]=k([]),l=t.get("search")||"",h=t.get("type")||null,f=t.get("onlyUnread")==="true",p=N(!0);async function g(){try{i(!0);const m=await H({search:l,type:h??void 0,onlyUnread:f});o(m.items),c(null)}catch(m){c(m?.message??"Failed to load rooms")}finally{i(!1)}}return D(()=>{g()},[l,h,f]),D(()=>{if(!p)return;const m=a=>{g()};return p.on("chat.message",m),()=>{p.off("chat.message",m)}},[p]),{rooms:u,loading:r,error:n,refresh:g,filters:{search:l,type:h,onlyUnread:f},setFilter:(m,a)=>{const d=new URLSearchParams(t);m==="onlyUnread"||a?d.set(m,String(a)):d.delete(m),s(d,{replace:!0})}}}const{Avatar:Z,Badge:ee,Box:v,Divider:te,IconButton:R,InputAdornment:se,List:re,ListItemButton:ae,ListItemText:ne,Stack:L,TextField:oe,Tooltip:b,Typography:z}=await x("@mui/material"),{useNavigate:ie,useSearchParams:ce}=await x("react-router-dom");function le(){const{rooms:t,filters:s,setFilter:r,loading:i}=X(),[n]=ce(),c=ie(),u=n.get("room");return e.jsxs(v,{sx:{width:360,borderRight:1,borderColor:"divider",height:"100%",display:"flex",flexDirection:"column"},children:[e.jsxs(v,{sx:{p:1.5},children:[e.jsx(oe,{fullWidth:!0,size:"small",placeholder:"Search conversationsâ€¦",value:s.search,onChange:o=>r("search",o.target.value),InputProps:{startAdornment:e.jsx(se,{position:"start",children:"ðŸ”Ž"})}}),e.jsxs(L,{direction:"row",spacing:1,sx:{mt:1},children:[e.jsx(b,{title:"Only unread",children:e.jsx(R,{onClick:()=>r("onlyUnread",!s.onlyUnread),color:s.onlyUnread?"primary":"default",size:"small",children:"ðŸŸ£"})}),e.jsx(b,{title:"DMs",children:e.jsx(R,{onClick:()=>r("type",s.type==="dm"?"":"dm"),color:s.type==="dm"?"primary":"default",size:"small",children:"ðŸ‘¤"})}),e.jsx(b,{title:"Groups",children:e.jsx(R,{onClick:()=>r("type",s.type==="group"?"":"group"),color:s.type==="group"?"primary":"default",size:"small",children:"ðŸ‘¥"})})]})]}),e.jsx(te,{}),e.jsx(v,{sx:{flex:1,overflowY:"auto"},children:e.jsxs(re,{disablePadding:!0,children:[t.map(o=>{const l=o.name||o.participants.map(f=>f.name).join(", "),h=u===o.id;return e.jsxs(ae,{selected:h,onClick:()=>c(`/chat?room=${encodeURIComponent(o.id)}`,{replace:!1}),children:[e.jsx(ee,{color:"primary",badgeContent:o.unreadCount||0,overlap:"circular",anchorOrigin:{vertical:"bottom",horizontal:"right"},children:e.jsx(Z,{sx:{mr:1},children:l.slice(0,1)})}),e.jsx(ne,{primary:e.jsxs(L,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(z,{variant:"body1",noWrap:!0,children:l}),o.lastMessageAt&&e.jsx(z,{variant:"caption",color:"text.secondary",children:new Date(o.lastMessageAt).toLocaleTimeString()})]}),secondary:o.entityRef?`${o.entityRef.type} â€¢ ${o.entityRef.id}`:void 0,primaryTypographyProps:{noWrap:!0}})]},o.id)}),!t.length&&!i&&e.jsx(v,{sx:{p:2,textAlign:"center",color:"text.secondary"},children:"No conversations"})]})})]})}const{useCallback:S,useEffect:F,useRef:de,useState:C}=await x("react");function ue(t){const[s,r]=C([]),[i,n]=C(!1),[c,u]=C(!1),[o,l]=C(null),h=de(null),f=N(!!t),p=S((a,d=!1)=>{r(y=>{const $=new Map;for(const j of d?a:y)$.set(j.id,j);for(const j of d?y:a)$.set(j.id,j);return Array.from($.values()).sort((j,K)=>j.createdAt.localeCompare(K.createdAt))})},[]),g=S(async()=>{if(t){u(!0);try{const a=await B(t,{pageSize:50});h.current=a.items.length?a.items[0].id:null,n(!!a.hasMore),r(a.items.sort((d,y)=>d.createdAt.localeCompare(y.createdAt))),l(null)}catch(a){l(a?.message??"Failed to load messages")}finally{u(!1)}}},[t]),P=S(async()=>{if(!(!t||!h.current||c))try{u(!0);const a=await B(t,{before:h.current,pageSize:50});a.items.length&&(h.current=a.items[0].id),n(!!a.hasMore),p(a.items,!0)}catch(a){l(a?.message??"Failed to load more messages")}finally{u(!1)}},[t,p,c]);F(()=>{g()},[g]),F(()=>{if(!f||!t)return;const a=d=>{d?.roomId===t&&p([d])};return f.on("chat.message",a),()=>{f.off("chat.message",a)}},[f,t,p]);const m=S(async a=>{if(!t)return;const d={id:"temp_"+Math.random().toString(36).slice(2),roomId:t,sender:{id:"me",name:"Me"},text:a.text,attachments:[],createdAt:new Date().toISOString(),status:"sending"};p([d]);try{const y=await V(t,a);p([y])}catch{}},[t,p]);return{messages:s,hasMore:i,loading:c,error:o,loadMore:P,send:m,reload:g}}const{Avatar:me,Box:E,Card:xe,CardContent:pe,Typography:A}=await x("@mui/material");function he({m:t,isMine:s}){return e.jsxs(E,{sx:{display:"flex",justifyContent:s?"flex-end":"flex-start",my:.5},children:[!s&&e.jsx(me,{sx:{width:28,height:28,mr:1},children:t.sender.name.slice(0,1)}),e.jsx(xe,{elevation:0,sx:{maxWidth:"75%",bgcolor:s?"primary.main":"background.paper",color:s?"primary.contrastText":"text.primary"},children:e.jsxs(pe,{sx:{py:1,px:1.5},children:[t.text&&e.jsx(A,{variant:"body2",sx:{whiteSpace:"pre-wrap",wordBreak:"break-word"},children:t.text}),!!t.attachments?.length&&e.jsx(E,{sx:{mt:.5},children:t.attachments.map(r=>e.jsxs(A,{variant:"caption",sx:{display:"block"},children:["ðŸ“Ž"," ",e.jsx("a",{href:r.url,target:"_blank",rel:"noreferrer",children:r.name})]},r.id))}),t.status==="sending"&&e.jsx(A,{variant:"caption",sx:{opacity:.6},children:"sendingâ€¦"})]})})]})}const fe=await x("react"),{Box:ge,IconButton:ye,TextField:je,Tooltip:we}=await x("@mui/material");function ve({onSend:t}){const[s,r]=fe.useState(""),i=()=>{const n=s.trim();n&&(t({text:n}),r(""))};return e.jsxs(ge,{sx:{borderTop:1,borderColor:"divider",p:1,display:"flex",alignItems:"center",gap:1},children:[e.jsx(je,{fullWidth:!0,placeholder:"Type a messageâ€¦",value:s,onChange:n=>r(n.target.value),onKeyDown:n=>{n.key==="Enter"&&(n.ctrlKey||n.metaKey)&&i()}}),e.jsx(we,{title:"Send (Ctrl/âŒ˜+Enter)",children:e.jsx(ye,{color:"primary",onClick:i,children:"âž¡ï¸"})})]})}const{Box:w,CircularProgress:Se,Divider:U,Stack:Ce,Typography:M}=await x("@mui/material"),{useSearchParams:$e}=await x("react-router-dom");function ke(){const[t]=$e(),s=t.get("room"),{messages:r,hasMore:i,loading:n,error:c,loadMore:u,send:o}=ue(s);return s?e.jsxs(w,{sx:{flex:1,display:"flex",flexDirection:"column",minWidth:0},children:[e.jsx(w,{sx:{px:2,py:1},children:e.jsxs(M,{variant:"h6",children:["Room: ",s]})}),e.jsx(U,{}),e.jsxs(w,{sx:{flex:1,overflowY:"auto",p:2,display:"flex",flexDirection:"column"},children:[i&&e.jsx(w,{sx:{textAlign:"center",mb:1},children:e.jsx(M,{variant:"caption",sx:{cursor:"pointer"},onClick:u,children:n?"Loadingâ€¦":"Load earlier messages"})}),r.map(l=>e.jsx(he,{m:l,isMine:l.sender.id==="me"},l.id)),n&&e.jsx(w,{sx:{display:"flex",justifyContent:"center",mt:1},children:e.jsx(Se,{size:20})}),c&&e.jsx(M,{color:"error",variant:"caption",children:c})]}),e.jsx(U,{}),e.jsx(w,{children:e.jsx(Ce,{direction:"row",sx:{width:"100%"},children:e.jsx(ve,{onSend:o})})})]}):e.jsx(w,{sx:{flex:1,display:"grid",placeItems:"center",color:"text.secondary"},children:"Select a conversation"})}const{Box:Re,Button:I,Stack:W,TextField:be,InputAdornment:Ae}=await x("@mui/material"),{useSearchParams:Me}=await x("react-router-dom");function ze(){const[t,s]=Me(),r=e.jsxs(W,{direction:"row",spacing:1,children:[e.jsx(I,{variant:"outlined",size:"small",children:"New DM"}),e.jsx(I,{variant:"contained",size:"small",children:"New Group"})]}),i=e.jsx(W,{direction:"row",spacing:1,children:e.jsx(be,{size:"small",placeholder:"Searchâ€¦",value:t.get("search")||"",onChange:n=>{const c=new URLSearchParams(t),u=n.target.value;u?c.set("search",u):c.delete("search"),s(c,{replace:!0})},InputProps:{startAdornment:e.jsx(Ae,{position:"start",children:"ðŸ”Ž"})}})});return e.jsx(O,{title:"Chat",subtitle:"Direct & group messaging",actions:r,toolbar:i,children:e.jsxs(Re,{sx:{display:"flex",minHeight:560,overflow:"hidden"},children:[e.jsx(le,{}),e.jsx(ke,{})]})})}export{ze as default};
//# sourceMappingURL=ChatPage-DVdiIfSG.js.map
